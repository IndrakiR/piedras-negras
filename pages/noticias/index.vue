<template>
  <div>
    <!-- Sección Banner original -->
    <BannerSection
      title="Noticias y Comunicados"
      subtitle="Mantente informado sobre las últimas novedades y acontecimientos en Piedras Negras"
      :cards="[
        {
          icon: 'fas fa-newspaper',
          title: 'Noticias Recientes',
          description: 'Últimas actualizaciones y eventos del municipio'
        },
        {
          icon: 'fas fa-bullhorn',
          title: 'Comunicados Oficiales',
          description: 'Anuncios importantes de la administración municipal'
        },
        {
          icon: 'fas fa-calendar-alt',
          title: 'Agenda Municipal',
          description: 'Próximos eventos y actividades en la ciudad'
        }
      ]"
    />

    <section class="py-12 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Encabezado centrado -->
        <div class="text-center mb-8">
          <h2 class="text-3xl font-semibold text-gray-900">Últimas Noticias</h2>
          <p class="text-base text-gray-500 mt-2">
            Mantente al día con los eventos más recientes de la ciudad
          </p>
        </div>

        <!-- Mensaje de error (opcional) -->
        <div v-if="error" class="text-red-600 text-center mb-6">
          Error al cargar las noticias: {{ error.message }}
        </div>

        <!-- Indicador de carga (opcional) -->
        <div v-else-if="pending" class="text-center mb-6">
          Cargando noticias...
        </div>

        <!-- Contenedor con transition-group (tu animación "fade") -->
        <transition-group
          v-else
          tag="div"
          name="fade"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 justify-items-center"
        >
          <!-- Iteración de las noticias visibles -->
          <article
            v-for="(news, index) in visibleNews"
            :key="index"
            class="w-full bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300"
          >
            <!-- Imagen de la noticia -->
            <img
              :src="news.img"
              :alt="news.title"
              class="w-full h-48 md:h-60 object-cover rounded-t-lg"
            />

            <!-- Transición individual para expandir/contraer texto (tu "expand") -->
            <transition name="expand">
              <!-- Contenido textual -->
              <div class="p-4" v-if="true">
                <time class="text-sm text-gray-500 block">{{ news.date }}</time>
                <h3 class="mt-2 text-lg font-medium text-gray-900">
                  {{ news.title }}
                </h3>

                <!-- Mostrar fullDesc si está expandida, si no shortDesc -->
                <p
                  class="mt-2 text-sm text-gray-600"
                  :class="!isExpanded(index) ? 'line-clamp-2' : ''"
                >
                  {{ isExpanded(index) ? news.fullDesc : news.shortDesc }}
                </p>

                <!-- Botón Leer más / Leer menos -->
                <button
                  class="mt-2 md:mt-3 inline-flex items-center text-xs md:text-sm font-medium text-[#5e1210] hover:text-[#801815] focus:outline-none"
                  @click="toggleExpand(index)"
                >
                  {{ isExpanded(index) ? 'Leer menos' : 'Leer más' }}
                  <!-- Ícono con Nuxt Icon -->
                  <Icon name="heroicons:arrow-right-20-solid" class="ml-1 w-4 h-4" />
                </button>
              </div>
            </transition>
          </article>
        </transition-group>

        <!-- Botón "Cargar más" -->
        <div class="mt-8 text-center">
          <button
            v-if="itemsToShow < mappedNews.length"
            @click="loadMore"
            class="inline-flex items-center px-3 py-1.5 md:px-4 md:py-2 border border-transparent text-xs md:text-sm font-medium rounded-md text-white bg-[#5e1210] hover:bg-[#801815] transition-colors duration-300"
          >
            Cargar más
          </button>
        </div>
      </div>
    </section>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { useFetch } from '#app'
import BannerSection from '~/components/BannerSection.vue'

// 1) Conexión con tu Payload (ajusta la URL a tu entorno)
const { data: fetchedData, pending, error } = await useFetch<{
  docs: Array<{
    // Ajusta estos campos a los de tu colección
    title: string
    content: string
    summary: string
    publishedDate?: string
    image?: { url?: string }
  }>
}>('http://localhost:4000/api/news', {
  method: 'GET',
  // Puedes pasar query params si necesitas filtrar o paginar
  // query: { 'where[status][equals]': 'published', limit: 50 },
})

// 2) Mapeamos la respuesta de Payload a tu estructura: (date, title, shortDesc, fullDesc, img...)
const mappedNews = computed(() => {
  // fallback a array vacío si no viene data
  const docs = fetchedData.value?.docs ?? []
  return docs.map((item) => {
    const dateFormatted = item.publishedDate
      ? new Date(item.publishedDate).toLocaleDateString('es-MX', {
          day: 'numeric',
          month: 'short',
          year: 'numeric',
        })
      : 'Sin fecha'

    return {
      date: dateFormatted,
      title: item.title || 'Sin título',
      shortDesc: item.summary || '',
      fullDesc: item.content || '',

      // Si 'image.url' viene relativo (/media/...), concatenamos la URL base
      img: item.image?.url
        ? `http://localhost:4000${item.image.url}`
        : 'https://placehold.co/400x225',
    }
  })
})

// 3) Control de cuántas noticias mostrar al inicio
const itemsToShow = ref(3)
const visibleNews = computed(() => mappedNews.value.slice(0, itemsToShow.value))

function loadMore() {
  itemsToShow.value += 3
}

// 4) Manejo de expandir/contraer cada tarjeta
const expandedIndex = ref<number | null>(null)

function isExpanded(index: number) {
  return expandedIndex.value === index
}

function toggleExpand(index: number) {
  expandedIndex.value = expandedIndex.value === index ? null : index
}
</script>

<style scoped>
/* Transiciones para nuestro "fade" (al montar/desmontar tarjetas) */
.fade-enter-active,
.fade-leave-active {
  transition: all 0.3s ease;
}
.fade-enter-from,
.fade-leave-to {
  opacity: 0;
  transform: scale(0.95);
}

/* Animación para expandir texto (al mostrar la fullDesc) */
.expand-enter-active,
.expand-leave-active {
  transition: max-height 0.3s ease, opacity 0.3s ease;
}
.expand-enter-from,
.expand-leave-to {
  max-height: 0;
  opacity: 0;
}

/* Truncar texto a 2 líneas */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
